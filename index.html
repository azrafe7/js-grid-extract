<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Grid Cell Extractor</title>
    <style>
        .row {
            margin-top: 10px;
        }
        canvas {
            border: 1px solid #ddd;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>Image Grid Cell Extractor</h1>
    <input type="file" id="imageUpload" accept="image/*">
    <h2>Input Image</h2>
    <canvas id="inputCanvas"></canvas>
    <h2>Extracted Cells</h2>
    <div id="outputImages"></div>

    <script>
        document.getElementById('imageUpload').addEventListener('change', handleImageUpload);

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = () => {
                const canvas = document.getElementById('inputCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                const cellWidth = 50;
                const cellHeight = 50;
                const borderWidth = 4;

                const outputDiv = document.getElementById('outputImages');
                outputDiv.innerHTML = '';

                // Process each cell by row
                for (let row = 0; row < 3; row++) {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'row';
                    outputDiv.appendChild(rowDiv);

                    let cols = row === 0 ? 2 : (row === 1 ? 10 : 5);
                    for (let col = 0; col < cols; col++) {
                        // Calculate cell coordinates
                        const x = col * cellWidth;
                        const y = row * cellHeight;

                        // Create canvas for each cell
                        const cellCanvas = document.createElement('canvas');
                        const cellCtx = cellCanvas.getContext('2d');
                        cellCanvas.width = cellWidth - 2 * borderWidth;
                        cellCanvas.height = cellHeight - 2 * borderWidth;

                        // Extract the cell image
                        cellCtx.drawImage(canvas, x + borderWidth, y + borderWidth, cellWidth - 2 * borderWidth, cellHeight - 2 * borderWidth, 0, 0, cellWidth - 2 * borderWidth, cellHeight - 2 * borderWidth);

                        // Process the cell image to replace blackish color with average color
                        processCellImage(cellCtx, cellCanvas.width, cellCanvas.height);

                        // Add to the row div
                        rowDiv.appendChild(cellCanvas);
                    }
                }
            }
        }

        function processCellImage(cellCtx, width, height) {
            const imageData = cellCtx.getImageData(0, 0, width, height);
            const data = imageData.data;

            let rSum = 0, gSum = 0, bSum = 0;
            let count = 0;

            // Calculate the average color of the cell
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];
                    const alpha = data[index + 3];

                    // Only consider non-transparent pixels
                    if (alpha > 0) {
                        rSum += r;
                        gSum += g;
                        bSum += b;
                        count++;
                    }
                }
            }

            const avgR = rSum / count;
            const avgG = gSum / count;
            const avgB = bSum / count;
            //const avgR = 255;
            //const avgG = 0;
            //const avgB = 0;

            // Replace blackish color with the average color, avoiding the border
            const threshold = 150;
            const borderSizeThreshold = 8;
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    // Apply replacement if within borderSizeThreshold pixels from the border
                    if (x < borderSizeThreshold || x >= width - borderSizeThreshold || y < borderSizeThreshold || y >= height - borderSizeThreshold) {

						const index = (y * width + x) * 4;
						const r = data[index];
						const g = data[index + 1];
						const b = data[index + 2];

						if (r < threshold && g < threshold && b < threshold) {
							//data[index] = avgR;
							//data[index + 1] = avgG;
							//data[index + 2] = avgB;
						}
					}
                }
            }

            // Update the canvas with the processed image data
            cellCtx.putImageData(imageData, 0, 0);
        }
    </script>
</body>
</html>
